name: Build Dev Planner

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtnetworkauth'
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Install NSIS
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      - name: Configure CMake
        run: |
          cd cpp
          mkdir build
          cd build
          cmake .. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cd cpp/build
          nmake
      
      - name: Deploy Qt dependencies
        run: |
          cd cpp/build
          windeployqt --release --no-translations DevPlanner.exe
      
      - name: Create Installer
        run: |
          cd cpp/build
          Copy-Item ../installer/windows.nsi .
          Copy-Item ../../LICENSE .
          & "C:\Program Files (x86)\NSIS\makensis.exe" /DVERSION="${{ github.ref_name }}" windows.nsi
      
      - name: Rename installer
        run: |
          if (Test-Path "cpp/build/DevPlannerSetup.exe") {
            Move-Item "cpp/build/DevPlannerSetup.exe" "cpp/build/Dev.Planner.Setup.exe"
          }
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: Dev-Planner-Windows
          path: cpp/build/Dev.Planner.Setup.exe
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.0'
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtnetworkauth'
      
      - name: Configure CMake
        run: |
          cd cpp
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cd cpp/build
          make -j$(sysctl -n hw.ncpu)
      
      - name: Deploy Qt dependencies
        run: |
          cd cpp/build
          macdeployqt DevPlanner.app -dmg
      
      - name: Rename DMG
        run: |
          mv cpp/build/DevPlanner.dmg cpp/build/Dev.Planner.macOS.dmg
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: Dev-Planner-macOS
          path: cpp/build/Dev.Planner.macOS.dmg

  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
      
      - name: List files
        run: find . -type f
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Dev-Planner-Windows/Dev.Planner.Setup.exe
            Dev-Planner-macOS/Dev.Planner.macOS.dmg
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸš€ Dev Planner v${{ github.ref_name }}
            
            ### Downloads
            - **Windows**: `Dev.Planner.Setup.exe` - Windows installer
            - **macOS**: `Dev.Planner.macOS.dmg` - macOS disk image
            
            ### What's New
            - AI Co-Pilot with modular action system
            - Note mode for quick notes
            - Improved status indicators
            - New app icon
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
